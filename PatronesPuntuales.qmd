---
title: "Patrones Puntuales Espaciales"
author: 
  - Santiago Rojas 
format: html
toc: true
toc-location: left
lang: es
editor: source
df-print: paged
code-fold: show
code-tools:
  source: false
  toggle: true
  caption: none
execute: 
  warning: false
tbl-colwidths: auto
link-external-newwindow: true
editor_options: 
  chunk_output_type: console

---


# Introducción

El terrorismo es un fenómeno que ha afectado a cada país en cierta medida. Aunque es más característico de algunas zonas del mundo, incluso países en desarrollo como los de América Latina no se han librado del uso del terror contra inocentes. En Colombia, específicamente, el impacto del terrorismo es alarmante, ya que afecta a un total de 9.514.863 personas, lo cual representa un 18.44% de la población colombiana. Esto evidencia la gravedad del problema en este país latinoamericano.

# Marco teórico

El terrorismo no puede ser simplificado ni fácilmente tipificado, ya que puede presentarse de diferentes formas. En el caso de Colombia, se trata de un terrorismo que ha tenido como objetivo cambiar regulaciones estatales. Específicamente, a finales de los años ochenta, el terrorismo adoptó un carácter político en el país, oponiéndose a la extradición, atacando a la policía, la justicia y los medios de comunicación que se oponían a los intereses de los carteles de la droga. Esta etapa se recuerda con estremecimiento debido al baño de sangre que se produjo. Las instituciones y la sociedad colombiana pagaron un precio muy alto durante este período. Sin embargo, la violencia terrorista cesó cuando quedó claro que los recursos institucionales y la ayuda de la comunidad internacional lograron derrotar al cartel de Medellín. Aunque el terrorismo era percibido principalmente como un problema rural y aislado, durante esta época llegó a las ciudades, afectando a todas las clases sociales y a las instituciones centrales del Estado.

El terrorismo en Colombia está vinculado a grupos guerrilleros como las FARC, el ELN, el EPL y la AUC, así como a otros grupos que ya desaparecieron, como el M-19, Quintín Lame y muchos más. Todas estas guerrillas han tenido un impacto negativo significativo en el país. Algunas de las consecuencias son: la pérdida de vidas humanas, incluyendo civiles, militares y guerrilleros a lo largo del conflicto armado interno; el desplazamiento forzado, siendo la violencia generada por la guerrilla una de las principales causas del desplazamiento interno en Colombia, obligando a millones de personas a abandonar sus hogares y comunidades debido al temor a la violencia y persecución; y el cultivo y tráfico de drogas, donde algunas guerrillas han estado involucradas en estas actividades ilícitas, contribuyendo a la consolidación de economías ilegales y a la violencia asociada al narcotráfico.

En resumen, el terrorismo, principalmente causado por grupos guerrilleros, está muy presente en Colombia, como lo demuestra su posición en el puesto 15 en el índice de terrorismo global.

# Paquetes, lectura de la DB y el mapa de Colombia: 

## Paquetes:

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(magrittr)
library(sf)
library(spatstat)
library(mapview)
```

## Lectura de la base de datos y el mapa de Colombia:

La base de datos pertenece a un dataset de Kaggle sobre terrorismo global, el cual, para el propósito de este trabajo, vamos a tomar la información pertinente a Colombia. Esto nos lleva a tener un conjunto de datos de **7,835** observaciones que abarcan desde el año **1970** hasta el **2017**. 
Se toma del **DANE** la información necesaria para tener información del contorno de Colombia. 

<https://www.kaggle.com/datasets/START-UMD/gtd>

```{r, warning=FALSE, message=FALSE, cache=TRUE}
colombia <- st_read("Maps_Shapes_and_Objects/MGN_DPTO_POLITICO.shp")
border_col <- st_coordinates(colombia$geometry)

db <- read.csv("Data/Colombia_Terrorism.csv")
coord <- data.frame(x=as.numeric(db$longitude), y=as.numeric(db$latitude))

load("Maps_Shapes_and_Objects/Contour_Points.RData")
```

# Visualizacíon de los datos 

## Mapa de Colombia
```{r}
mapview(colombia, legend=F, col.regions="gray") + 
  mapview(coord, xcol="x", y="y")
```

A simple vista se puede observar una gran cantidad de lugares afectados por actos violentos. Se destacan los departamentos centrales y del norte de Colombia por contar con una gran cantidad de ocurrencias, lo cual nos lleva a concluir de manera descriptiva la existencia de aglomeraciones o conglomerados **(Clusters)** de actos violentos en ciertos departamentos de Colombia. 


```{r}
ppp.col <- readRDS("Maps_Shapes_and_Objects/ppp.col.Rds")
qc.col <- quadratcount(ppp.col, nx = 3, ny = 3)
plot(ppp.col, main = "Conteo por cuadrantes",
     axes = T, xaxt = "n", yaxt = "n")
plot(qc.col, add = T, textargs = list(col = "red"))
```

Del gráfico anterior de conteos por cuadrante se aprecia la cantidad de ocurrencias de actos violentos en el interior de Colombia, mostrando de manera más detallada que los departamentos ubicados en el centro y el norte del país fueron altamente afectados. De esta manera, se evidencia la falta de simetría en la cantidad de ocurrencias por cuadrante, lo que nos lleva a concluir descriptivamente que existe la posibilidad de encontrar algún tipo de patrón espacial.


# Prueba chi-cuadrado


$$
\begin{cases}
\begin{aligned}
\text{H}_0: &\text{Aleatoriedad Espacial} \\
\text{H}_1: &\text{Autocorrelacón Espacial}
\end{aligned}
\end{cases}
$$

```{r}
quadrat.test(ppp.col)
```

Con un **p-valor < ** $\alpha = 0.05$, esto nos permite rechazar la hipótesis de homogeneidad de intensidad, lo que nos indica que estamos frente a un proceso **poisson inhomogéneo**. Esto implica que la intensidad puede ser modelada mediante alguna relación $\lambda(x,y)$, ya sea a través de una relación funcional paramétrica o no paramétrica (kernel).


```{r, echo = F}
graph_ppp <- function(sigma, scott = F) {
  ds <- density.ppp(ppp.col, sigma = sigma)
  title <- ifelse(scott, paste("Ancho de banda en x:", sigma[1],
                               "\nAncho de banda en y:", sigma[2]),
                  paste0("Ancho de banda: ", sigma))
  plot(ds, main = title)
}
bwds <- readRDS("Maps_Shapes_and_Objects/bandwidths.Rds")
```


De manera descriptiva y utilizando el test $\chi^2$, se comprueba que el parámetro de la intensidad no es constante. Por lo tanto, se procede a realizar un ajuste utilizando algunos métodos de suavizamiento. 


# Estimación no parametrica de la intensidad (Kernels)


:::{.panel-tabset}

## Empírico

```{r, echo = F}
graph_ppp(2000)
plot(locations, add = T, cex = 0.2)
```


## Diggle

```{r, echo = F}
graph_ppp(bwds[[1]])
plot(locations, add = T, cex = 0.2)
```


## CvL

```{r, echo = F}
graph_ppp(bwds[[3]])
plot(locations, add = T, cex = 0.2)
```


## PPL

```{r, echo = F}
graph_ppp(bwds[[5]])
plot(locations, add = T, cex = 0.2)
```


## Frac

```{r, echo = F}
graph_ppp(bwds[[4]])
plot(locations, add = T, cex = 0.2)
```


## Scott

```{r, echo = F}
graph_ppp(bwds[[2]], T)
plot(locations, add = T, cex = 0.2)
```

:::

Durante la estimación de la intensidad, se prueban diferentes anchos de banda con la intención de seleccionar el ancho de banda óptimo. Se observa que muchos métodos de suavizado no logran capturar de manera precisa la relación espacial. Se destaca el método **Scott** con un ancho de banda en **X** de **57,843.91** y un ancho de banda en **Y** de **88,432.46**, el cual asigna una mayor probabilidad de sufrir actos violentos a las zonas con mayores afectaciones y una menor probabilidad a las zonas con menores afectaciones. Concluimos que el método anterior, junto con su respectivo ancho de banda, se ajusta mejor a nuestro problema de investigación.  

```{r, echo=FALSE}
load("Maps_Shapes_and_Objects/models.RData")
```

# Estimación Parametrica de la intensidad

## Modelos Lineales

:::{.panel-tabset}

## Modelo lineal con tendencia en x 

$$log[\lambda_{\theta}(x, y)] = \theta_0 + \theta_1 x$$

#### Estimación

```{r, echo = F}
plot(predict(models_list[[1]]), main = "Modelo lineal con tendencia en x")
plot(locations, add = T, cex = 0.4, pch = 20)
```

#### Residuales

```{r, echo = F, results='hide'}
diagnose.ppm(models_list[[1]], which = "smooth",
             main = "Modelo lineal con tendencia en x")
```



## Modelo lineal con tendencia en y 

$$log[\lambda_{\theta}(x, y)] = \theta_0 + \theta_1 y$$

#### Estimación

```{r, echo = F}
plot(predict(models_list[[2]]), main = "Modelo lineal con tendencia en y")
plot(locations, add = T, cex = 0.4, pch = 20)
```

#### Residuales

```{r, echo = F, results='hide'}
diagnose.ppm(models_list[[2]], which = "smooth",
             main = "Modelo lineal con tendencia en y")
```


## Modelo lineal con tendencia en ambas direcciones 

$$log[\lambda_{\theta}(x, y)] = \theta_0 + \theta_1 x + \theta_2 y$$

#### Estimación

```{r, echo = F}
plot(predict(models_list[[3]]),
     main = "Modelo lineal con tendencia\nen ambas direcciones")
plot(locations, add = T, cex = 0.4, pch = 20)
```

#### Residuales

```{r, echo = F, results='hide'}
diagnose.ppm(models_list[[3]], which = "smooth",
             main = "Modelo lineal con tendencia\nen ambas direcciones")
```

:::

## Modelos cuadráticos 

:::{.panel-tabset}

## Modelo cuadrático sin términos cruzados

$$log[\lambda_{\theta}(x, y)] = \theta_0 + \theta_1 x + \theta_2 y + \theta_3 x^2 + \theta_4 y^2$$

#### Estimación

```{r, echo = F}
plot(predict(models_list[[4]]),
     main = "Modelo cuadrático sin interacción")
plot(locations, add = T, cex = 0.4, pch = 20)
```

#### Residuales

```{r, echo = F, results='hide'}
diagnose.ppm(models_list[[4]], which = "smooth",
             main = "Modelo cuadrático sin interacción")
```

## Modelo cuadrático con interacción 
$$log[\lambda_{\theta}(x, y)] = \theta_0 + \theta_1 x + \theta_2 y + \theta_3 x^2 + \theta_4 y^2 + \theta_5 xy$$

#### Estimación

```{r, echo = F}
plot(predict(models_list[[5]]),
     main = "Modelo cuadrático con interacción")
plot(locations, add = T, cex = 0.4, pch = 20)
```

#### Residuales

```{r, echo = F, results='hide'}
diagnose.ppm(models_list[[5]], which = "smooth",
             main = "Modelo cuadrático con interacción")
```
:::


Durante la estimación de la intensidad utilizando métodos paramétricos lineales y cuadráticos, se observa que los métodos lineales no capturan de manera óptima la relación espacial. Sin embargo, al utilizar **métodos cuadráticos** se logra una mejora sustancial. Se destaca especialmente el **método cuadrático con interacción**, ya que es el que mejor asigna la probabilidad de ocurrencia de eventos violentos en determinadas zonas de Colombia.

# Propiedades de segundo orden 

## K

```{r}
```

```{r, echo=FALSE, message=FALSE, eval=FALSE}
plot(Kest(ppp.col), main = "Función K", xlab="r [metros]")
```

## Correlación por pares

```{r, echo=FALSE, eval=FALSE}
plot(pcf(ppp.col), main = "Pair-Correlation estimada")
```


# Referencias
- Global Terrorism Database. Kaggle. Retrieved June 11, 2023, from <https://www.kaggle.com/datasets/START-UMD/gtd>

- Reporte victimas conflicto aramado. Gov.co. Retrieved June 11, 2023, <https://www.unidadvictimas.gov.co/es/registro-unico-de-victimas-ruv/37394>
  
- Policia nacional de colombia (n.d.). TERRORISMO POLÍTICO: DEFINICIÓN Y ALCANCES DE UN FENÓMENO ELUSIVO. Policia.gov.co. Retrieved June 11, 2023, from <https://www.policia.gov.co/sites/default/files/Terrorismo%20.pdf>

- Policia nacional de colombia TERRORISMO, NARCOTRÁFICO Y DELINCUENCIA. Policia.gov.co. Retrieved June 11, 2023, from    <https://www.policia.gov.co/file/6568/download?token=27d2k7iB>
  
- Overall Terrorism Index Score. Vision of Humanity. Retrieved June 11, 2023, from <https://www.visionofhumanity.org/maps/global-terrorism-index/#/>

- Contorno de Colombia, from <https://geoportal.dane.gov.co/servicios/descarga-y-metadatos/descarga-mgn-marco-geoestadistico-nacional/>